
root = @srcdir@
srcdir = $(root)/src
srcbin = $(srcdir)/progs
srclib = $(srcdir)/lib
srcinc = $(srcdir)/include
srcexm = $(srcdir)/examples

config = ./src/include/nanosoft/config.h

CPPFLAGS = @CPPFLAGS@ -I$(srcinc) -I./src/include
LDFLAGS = @LDFLAGS@ -L.
CFLAGS = @CFLAGS@ $(CPPFLAGS) -L.
CXXFLAGS = @CXXFLAGS@ $(CPPFLAGS)  -L.
LIBS = @LIBS@
CXX = @CXX@ $(CXXFLAGS)
CC = @CC@ $(CFLAGS)
AR = @AR@
RANLIB = @RANLIB@
INSTALL = @INSTALL@
MKDIR = @MKDIR@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
includedir = @includedir@

PREFIX = $(DESTDIR)$(prefix)
EPREFIX = $(DESTDIR)$(exec_prefix)
BINDIR = $(DESTDIR)$(bindir)
INCLUDEDIR = $(DESTDIR)$(includedir)
LIBDIR = $(DESTDIR)$(libdir)

INSTALL_BIN = $(INSTALL) -m755
INSTALL_INC = $(INSTALL) -m644
INSTALL_LIB = $(INSTALL) -m644

BUILD = @build@
HOST = @host@
HOST_OS = @host_os@

NETWORK_LIBS = @NETWORK_LIBS@
SASL = @SASL@
SASL_LIBS = @SASL_LIBS@

WITH_MYSQL = @WITH_MYSQL@
MYSQL_LIBS = @MYSQL_LIBS@

LINUX_PROGS=forker
LINUX_PROGS+=miniget
LINUX_PROGS+=wait
LINUX_PROGS+=time
LINUX_PROGS+=parse_url
LINUX_PROGS+=masterd
LINUX_PROGS+=nsu
LINUX_PROGS+=miniget2
LINUX_PROGS+=minisend
LINUX_PROGS+=showpath

LINUX_EXAMPLES=streams
LINUX_EXAMPLES+=options
LINUX_EXAMPLES+=string
LINUX_EXAMPLES+=daemon
LINUX_EXAMPLES+=pools

ifeq ($(WITH_MYSQL), yes)
LINUX_EXAMPLES+=mysql
endif

all: all-$(HOST_OS)
	date "+%d.%m.%Y %H:%M:%S" > build

.PHONY: install install-linux install-mingw32 install-headers
install: install-$(HOST_OS) install-headers

install-headers: install-core-headers install-xml-headers install-netd-headers install-sasl-headers

install-linux: forker miniget wait time masterd nsu miniget2 showpath libnanosoft.a
	$(MKDIR) -p $(BINDIR) $(LIBDIR) $(INCLUDEDIR)/nanosoft
	$(INSTALL_BIN) forker $(BINDIR)/forker
	$(INSTALL_BIN) miniget $(BINDIR)/miniget
	$(INSTALL_BIN) wait $(BINDIR)/wait
	$(INSTALL_BIN) time $(BINDIR)/time
	$(INSTALL_BIN) masterd $(BINDIR)/masterd
	$(INSTALL_BIN) nsu $(BINDIR)/nsu
	$(INSTALL_BIN) miniget2 $(BINDIR)/miniget2
	$(INSTALL_BIN) showpath $(BINDIR)/showpath
	$(INSTALL_LIB) libnanosoft.a $(LIBDIR)/libnanosoft.a

install-mingw32: libnanosoft.a miniget2
	$(INSTALL_BIN) miniget2 $(BINDIR)/miniget2
	$(INSTALL_LIB) libnanosoft.a $(LIBDIR)/libnanosoft.a

all-mingw32: libnanosoft.a miniget2 parse_url streams options string
	echo > all-mingw32

all-linux: $(LINUX_PROGS) $(LINUX_EXAMPLES) libnanosoft.a
	echo > all-linux

# PROGRAMS

forker: $(srcbin)/forker.c
	$(CC) $(srcbin)/forker.c -o forker

wait: $(srcbin)/wait.c
	$(CC) $(srcbin)/wait.c -o wait

time: $(srcbin)/time.c
	$(CC) $(srcbin)/time.c -o time

nsu: $(srcbin)/nsu.c
	$(CC) $(srcbin)/nsu.c -o nsu

masterd: $(srcbin)/masterd.c libnanosoft.a
	$(CC) $(srcbin)/masterd.c -lnanosoft -o masterd

miniget: $(srcbin)/miniget.c libnanosoft.a
	$(CC) $(srcbin)/miniget.c -lnanosoft -o miniget

miniget2: $(srcbin)/miniget.cpp libnanosoft.a
	$(CXX) $(srcbin)/miniget.cpp -lnanosoft -lstdc++ $(NETWORK_LIBS) -o miniget2

minisend: $(srcbin)/minisend.cpp libnanosoft.a
	$(CXX) $(srcbin)/minisend.cpp -lnanosoft -lstdc++ $(NETWORK_LIBS) -o minisend

showpath: $(srcbin)/showpath.c
	$(CXX) $(srcbin)/showpath.c -o showpath

# EXAMPLES

parse_url: $(srcexm)/parse_url.c libnanosoft.a
	$(CC) $(srcexm)/parse_url.c -lnanosoft -o parse_url

streams: $(srcexm)/streams.cpp libnanosoft.a
	$(CXX) $(srcexm)/streams.cpp -lnanosoft -lstdc++ -o streams

options: $(srcexm)/options.cpp  libnanosoft.a
	$(CXX) $(srcexm)/options.cpp -lnanosoft -lstdc++ -o options

string: $(srcexm)/string.cpp libnanosoft.a
	$(CXX) $(srcexm)/string.cpp -lnanosoft -lstdc++ -o string

pools: $(srcexm)/pools.cpp libnanosoft.a
	$(CXX) $(srcexm)/pools.cpp -lnanosoft -o pools

mysql: $(srcexm)/mysql.cpp libnanosoft.a
	$(CXX) $(srcexm)/mysql.cpp -lnanosoft -lpthread $(LDFLAGS) $(LIBS) -o mysql

daemon: $(srcexm)/daemon.cpp libnanosoft.a
	$(CXX) $(srcexm)/daemon.cpp -o daemon -lpthread -lnanosoft -lexpat

include $(root)/core.mf
include $(root)/xml.mf
include $(root)/netd.mf
include $(root)/sasl.mf

libnanosoft.a: $(NANOSOFT_CORE) $(NANOSOFT_XML) $(NANOSOFT_NETD) $(NANOSOFT_SASL)
	$(AR) rc libnanosoft.a $(NANOSOFT_CORE) $(NANOSOFT_XML) $(NANOSOFT_NETD) $(NANOSOFT_SASL)
	$(RANLIB) libnanosoft.a

.PHONY: clean distclean

distclean: clean
	rm -f Makefile *.log  $(config) config.status

clean:
	rm -f *.o build all-linux all-mingw32
	rm -f $(LINUX_PROGS) $(LINUX_EXAMPLES) lib*.a
