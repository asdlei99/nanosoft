
srcdir = @srcdir@/src
srcbin = $(srcdir)/progs
srclib = $(srcdir)/lib
srcinc = $(srcdir)/include
srcexm = $(srcdir)/examples


CFLAGS = @CFLAGS@ -I$(srcdir)/include -L.
CXXFLAGS = @CFLAGS@ -I$(srcdir)/include -L.
CXX = @CXX@ $(CXXFLAGS)
CC = @CC@ $(CFLAGS)
AR = @AR@
RANLIB = @RANLIB@
INSTALL = @INSTALL@

BINDIR = @bindir@
INCLUDEDIR = @includedir@
LIBDIR = @libdir@

BUILD = @build@
HOST = @host@
HOST_OS = @host_os@

NETWORK_LIBS = @NETWORK_LIBS@

all: all-$(HOST_OS)
	date "+%d.%m.%Y %H:%M:%S" > build

all-mingw32: libnanosoft.a miniget2 parse_url streams options
	echo > all-mingw32

all-linux: forker miniget wait time parse_url masterd nsu streams miniget2 options libnanosoft.a
	echo > all-linux

# PROGRAMS

forker: $(srcbin)/forker.c
	$(CC) $(srcbin)/forker.c -o forker

wait: $(srcbin)/wait.c
	$(CC) $(srcbin)/wait.c -o wait

time: $(srcbin)/time.c
	$(CC) $(srcbin)/time.c -o time

nsu: $(srcbin)/nsu.c
	$(CC) $(srcbin)/nsu.c -o nsu

masterd: $(srcbin)/masterd.c libnanosoft.a
	$(CC) $(srcbin)/masterd.c -lnanosoft -o masterd

miniget: $(srcbin)/miniget.c libnanosoft.a
	$(CC) $(srcbin)/miniget.c -lnanosoft -o miniget

miniget2: $(srcbin)/miniget.cpp libnanosoft.a
	$(CXX) $(srcbin)/miniget.cpp -lnanosoft -lstdc++ $(NETWORK_LIBS) -o miniget2

# EXAMPLES

parse_url: $(srcexm)/parse_url.c libnanosoft.a
	$(CC) $(srcexm)/parse_url.c -lnanosoft -o parse_url

streams: $(srcexm)/streams.cpp libnanosoft.a
	$(CXX) $(srcexm)/streams.cpp -lnanosoft -lstdc++ -o streams

options: $(srcexm)/options.cpp  libnanosoft.a
	$(CXX) $(srcexm)/options.cpp -lnanosoft -lstdc++ -o options

# LIBRARY

libnanosoft.a: nanoini.o nanostr.o nanourl.o options.o fstream.o socket.o http.o
	$(AR) rc libnanosoft.a nanoini.o nanostr.o nanourl.o options.o fstream.o socket.o http.o
	$(RANLIB) libnanosoft.a

# MODULES

nanoini.o: $(srclib)/nanoini.c $(srcinc)/nanoini.h
	$(CC) -c $(srclib)/nanoini.c

nanostr.o: $(srclib)/nanostr.c $(srcinc)/nanostr.h
	$(CC) -c $(srclib)/nanostr.c

nanourl.o: $(srclib)/nanourl.c $(srcinc)/nanourl.h
	$(CC) -c $(srclib)/nanourl.c

options.o: $(srclib)/options.cpp $(srcinc)/nanosoft/options.h
	$(CXX) -c $(srclib)/options.cpp

fstream.o: $(srclib)/fstream.cpp $(srcinc)/nanosoft/stream.h $(srcinc)/nanosoft/fstream.h
	$(CXX) -c $(srclib)/fstream.cpp

socket.o: $(srclib)/socket.cpp $(srcinc)/nanosoft/stream.h $(srcinc)/nanosoft/socket.h
	$(CXX) -c $(srclib)/socket.cpp

http.o: $(srclib)/http.cpp $(srcinc)/nanosoft/stream.h $(srcinc)/nanosoft/socket.h $(srcinc)/nanosoft/http.h $(srcinc)/nanourl.h
	$(CXX) -c $(srclib)/http.cpp

# CLEAN

distclean: clean
	rm -f Makefile *.log  $(srcinc)/nanosoft/config.h config.status

clean:
	rm -f *.o
	rm -f build all-linux all-mingw32
	rm -f forker miniget wait time parse_url masterd nsu streams miniget2 libnanosoft.a options
